<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Weather Query</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; max-width: 480px; margin: auto; }
    .weather-card { border: 1px solid #ccc; border-radius: 8px; padding: 12px; margin-top: 10px; }
    .forecast { margin-top: 20px; }
    .lang-switch { margin-bottom: 10px; }
    button { margin-right: 6px; padding: 6px 12px; }
  </style>
</head>
<body>
  <div class="lang-switch">
    <button id="enBtn">English</button>
    <button id="zhBtn">中文</button>
  </div>

  <h2 id="title">Weather Query</h2>

  <div>
    <input type="text" id="cityInput" placeholder="Enter city or country" style="width: 100%; padding: 8px;" />
    <button id="searchBtn" style="margin-top: 8px; padding: 8px 16px;">Search</button>
  </div>

  <div id="result"></div>

  <script>
    const apiKey = '143454aa39bbe3442a890cdbf3f9db36'; // 你提供的 API KEY

    let lang = 'en';

    document.getElementById('enBtn').onclick = () => { lang = 'en'; updateTexts(); };
    document.getElementById('zhBtn').onclick = () => { lang = 'zh'; updateTexts(); };

    function updateTexts() {
      if (lang === 'en') {
        document.getElementById('title').innerText = 'Weather Query';
        document.getElementById('cityInput').placeholder = 'Enter city or country';
        document.getElementById('searchBtn').innerText = 'Search';
      } else {
        document.getElementById('title').innerText = '天气查询';
        document.getElementById('cityInput').placeholder = '输入城市或国家';
        document.getElementById('searchBtn').innerText = '查询天气';
      }
    }

    updateTexts();

    document.getElementById('searchBtn').onclick = async () => {
      const city = document.getElementById('cityInput').value.trim();
      if (!city) return;

      try {
        // 先获取当前天气（包含 sunrise/sunset）
        const urlNow = `https://api.openweathermap.org/data/2.5/weather?q=${encodeURIComponent(city)}&appid=${apiKey}&units=metric&lang=${lang}`;
        const resNow = await fetch(urlNow);
        if (!resNow.ok) { document.getElementById('result').innerHTML = `<p>${lang==='en' ? 'City not found' : '未找到城市'}</p>`; return; }
        const dataNow = await resNow.json();

        // 再获取 5-day forecast
        const urlFc = `https://api.openweathermap.org/data/2.5/forecast?q=${encodeURIComponent(city)}&appid=${apiKey}&units=metric&lang=${lang}`;
        const resFc = await fetch(urlFc);
        const dataFc = await resFc.json();

        // 当前天气
        const sunrise = new Date(dataNow.sys.sunrise * 1000);
        const sunset  = new Date(dataNow.sys.sunset  * 1000);
        let html = `
          <div class="weather-card">
            <h3>${lang==='en' ? 'Current Weather for' : '当前天气 —'} ${dataNow.name}</h3>
            <p>${lang==='en' ? 'Temperature' : '温度'}: ${dataNow.main.temp}°C</p>
            <p>${lang==='en' ? 'Humidity' : '湿度'}: ${dataNow.main.humidity}%</p>
            <p>${lang==='en' ? 'Wind Speed' : '风速'}: ${dataNow.wind.speed} m/s</p>
            <p>${lang==='en' ? 'Sunrise' : '日出'}: ${sunrise.toLocaleTimeString()} | ${lang==='en' ? 'Sunset' : '日落'}: ${sunset.toLocaleTimeString()}</p>
          </div>
        `;

        // 3-day forecast
        html += `<div class="forecast"><h4>${lang==='en' ? '3-Day Forecast' : '三天预报'}</h4>`;
        const nowTs = Date.now()/1000;
        const forecastDays = {};

        // 从 forecast.list 中取未来三天中每天 12:00 的数据
        dataFc.list.forEach(item => {
          const d = new Date(item.dt * 1000);
          const key = d.getUTCDate();
          if (item.dt > nowTs && Object.keys(forecastDays).length < 3) {
            if (!forecastDays[key] && d.getUTCHours() === 12) {
              forecastDays[key] = item;
            }
          }
        });

        Object.values(forecastDays).forEach(item => {
          const d = new Date(item.dt*1000);
          html += `
            <div class="weather-card">
              <p>${d.toLocaleDateString()} — ${lang==='en' ? 'Temp' : '温度'}: ${item.main.temp}°C, ${item.weather[0].description}</p>
            </div>
          `;
        });

        html += `</div>`;
        document.getElementById('result').innerHTML = html;

      } catch (err) {
        document.getElementById('result').innerHTML = `<p>${lang==='en' ? 'Error fetching data' : '获取数据出错'}</p>`;
        console.error(err);
      }
    };
  </script>
</body>
</html>
